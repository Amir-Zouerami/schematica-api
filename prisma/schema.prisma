generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String  @id @default(cuid())
  username     String  @unique
  password     String?
  role         Role    @default(guest)
  profileImage String?

  tokenVersion Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  teamMemberships TeamMembership[]

  // "Blame" relations for tracking creation/updates
  createdProjects  Project[]  @relation("ProjectCreator")
  updatedProjects  Project[]  @relation("ProjectUpdater")
  createdEndpoints Endpoint[] @relation("EndpointCreator")
  updatedEndpoints Endpoint[] @relation("EndpointUpdater")
  writtenNotes     Note[]

  // Access control relations
  projectAccesses UserProjectAccess[]
  deniedProjects  Project[]           @relation("DeniedProjectAccess")

  // System-level relations
  auditLogs            AuditLog[]
  changelogs           Changelog[]
  notificationsAsActor Notification[]           @relation("NotificationActor")
  notificationStatuses UserNotificationStatus[] @relation("UserNotificationStatus")
  authProviders        AuthProvider[]

  createdSchemaComponents SchemaComponent[] @relation("CreatedSchemaComponents")
  updatedSchemaComponents SchemaComponent[] @relation("UpdatedSchemaComponents")
}

model Team {
  id        String   @id @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members         TeamMembership[]
  projectAccesses TeamProjectAccess[]
}

model TeamMembership {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId String

  @@id([userId, teamId])
}

model Project {
  id             String   @id @default(cuid())
  name           String
  nameNormalized String   @unique
  description    String?
  serverUrl      String?
  creator        User     @relation("ProjectCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  creatorId      String
  updatedBy      User     @relation("ProjectUpdater", fields: [updatedById], references: [id], onDelete: Restrict)
  updatedById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  links        ProjectLink[]
  endpoints    Endpoint[]
  environments Environment[]

  userAccesses UserProjectAccess[]
  teamAccesses TeamProjectAccess[]
  deniedUsers  User[]              @relation("DeniedProjectAccess")
  Changelog    Changelog[]

  schemaComponents SchemaComponent[]
}

model ProjectLink {
  id        Int     @id @default(autoincrement())
  name      String
  url       String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  @@unique([projectId, url])
}

model Endpoint {
  id     String @id @default(cuid())
  path   String
  method String

  status    EndpointStatus @default(DRAFT)
  operation Json
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  creator     User     @relation("EndpointCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  creatorId   String
  updatedBy   User     @relation("EndpointUpdater", fields: [updatedById], references: [id], onDelete: Restrict)
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  notes Note[]

  @@unique([projectId, path, method])
  @@index([projectId, status])
}

model Note {
  id         Int      @id @default(autoincrement())
  content    String
  endpoint   Endpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  endpointId String
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Environment {
  id          String   @id @default(cuid())
  name        String
  description String?
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  secrets Secret[]

  @@unique([projectId, name])
}

model Secret {
  id            Int         @id @default(autoincrement())
  key           String
  value         String
  description   String?
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  environmentId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([environmentId, key])
}

model AuthProvider {
  id         Int    @id @default(autoincrement())
  provider   String // e.g., "gitlab", "github"
  providerId String // The user's unique ID from the provider

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([provider, providerId])
  @@index([userId])
}

model SchemaComponent {
  id          String  @id @default(cuid())
  name        String
  description String?
  schema      Json

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  creator     User   @relation("CreatedSchemaComponents", fields: [creatorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  creatorId   String
  updatedBy   User   @relation("UpdatedSchemaComponents", fields: [updatedById], references: [id], onDelete: Restrict, onUpdate: Cascade)
  updatedById String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, name])
  @@index([projectId])
}

// --- Access Control Tables ---
model UserProjectAccess {
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  type      AccessType // "OWNER" or "VIEWER"

  @@id([userId, projectId])
}

model TeamProjectAccess {
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId    String
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  type      AccessType // "OWNER" or "VIEWER"

  @@id([teamId, projectId])
}

model AuditLog {
  id            Int      @id @default(autoincrement())
  actorId       String?
  actorUsername String
  action        String
  targetId      String
  details       Json?
  createdAt     DateTime @default(now())

  actor User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([targetId])
  @@index([createdAt])
}

model Changelog {
  id        Int      @id @default(autoincrement())
  projectId String
  relatedId String
  message   String
  actorId   String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  actor   User?   @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([projectId, createdAt])
}

model Notification {
  id        Int      @id @default(autoincrement())
  message   String
  link      String
  actorId   String?
  createdAt DateTime @default(now())

  actor        User?                    @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  userStatuses UserNotificationStatus[]

  @@index([createdAt])
}

model UserNotificationStatus {
  notificationId Int
  userId         String
  isRead         Boolean   @default(false)
  readAt         DateTime?

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation("UserNotificationStatus", fields: [userId], references: [id], onDelete: Cascade)

  @@id([notificationId, userId])
  @@index([userId, isRead])
}

enum Role {
  admin
  member
  guest
}

enum AccessType {
  OWNER
  VIEWER
}

enum EndpointStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  DEPRECATED
}
